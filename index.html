<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>桌遊社花費分攤計算機</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="./css/style.css"> <!-- 引入獨立的 style.css -->
    <link rel="stylesheet" href="./css/calculator.css">
    <link rel="stylesheet" href="./css/modal_styles.css"> <!-- 引入新的模態框樣式 -->
    <link rel="stylesheet" href="./css/firebase_styles.css"> <!-- 引入 Firebase 樣式 -->
</head>

<body>

    <div id="app" v-cloak>
        <nav class="navbar">
            <div class="navbar-brand"></div>
            <div class="navbar-buttons" :class="{'logged-out-buttons': !user, 'logged-in-buttons': user}">
                <button v-if="!user" @click="showLoginModal" class="firebase-button login-button"><i class="fa-solid fa-right-to-bracket"></i><span>登入</span></button>
                <button v-if="user" @click="firebaseSignOut" class="firebase-button logout-button"><i class="fa-solid fa-right-from-bracket"></i><span>登出</span></button>
                <button v-if="user" @click="toggleAutoBackup" :class="{'firebase-button': true, 'auto-backup-on': enableAutoBackup, 'auto-backup-off': !enableAutoBackup}">
                    <i class="fa-solid fa-cloud-arrow-up"></i> <span>{{ enableAutoBackup ? 'Auto: on' : 'Auto: off' }}</span>
                </button>
                <button v-if="user" @click="backupToCloud(false)" class="firebase-button backup-button"><i class="fa-solid fa-cloud-arrow-up"></i> <span>備份</span></button>
                <button v-if="user" @click="restoreFromCloud" class="firebase-button restore-button"><i class="fa-solid fa-cloud-arrow-down"></i> <span>還原</span></button>
            </div>
        </nav>

        <!-- 登入模態框 -->
        <div v-if="loginModalVisible" class="custom-modal-overlay" @click.self="cancelLoginModal">
            <div class="custom-modal-content login-modal-content">
                <h3>登入 / 註冊</h3>
                <input type="email" v-model="loginEmail" placeholder="電子郵件" class="login-input" @keyup.enter="handleEmailSignIn">
                <input type="password" v-model="loginPassword" placeholder="密碼" class="login-input" @keyup.enter="handleEmailSignIn">
                <div class="remember-me-group">
                    <input type="checkbox" id="rememberMe" v-model="rememberMe">
                    <label for="rememberMe">記住我</label>
                </div>
                <div class="login-actions">
                    <button @click="handleEmailSignIn" class="firebase-button">登入</button>
                    <button @click="handleEmailSignUp" class="firebase-button signup-button">註冊</button>
                </div>
                <p v-if="loginError" class="login-error-message">{{ loginError }}</p>
            </div>
        </div>

        <h1>桌遊社花費分攤計算機</h1>
        <div class="top-controls">
            <div class="save-load-controls">
                <div class="save-clear-group">
                    <button @click="saveCurrentData" class="save-button"><i class="fa-solid fa-save"></i> 保存</button>
                    <button @click="clearInputs" class="clear-button"><i class="fa-solid fa-eraser"></i> 清空</button>
                </div>
                <select v-model="selectedSaveEntry" @change="handleSaveEntrySelection" class="load-dropdown">
                    <option value="">選擇要載入的數據</option>
                    <option v-for="entry in savedEntries" :key="entry.date" :value="entry.date">
                        {{ entry.date }}
                    </option>
                </select>
            </div>
        </div>
        <div v-if="loadMessage" class="message-display">
            {{ loadMessage }}
        </div>
        <div class="card">
            <h2>代墊費用</h2>
            <div class="input-group">
                <label>代墊餐費</label>
                <!-- 移除 input-row 容器，讓餐費區塊垂直堆疊 -->
                <div class="input-wrapper meal-entries">
                    <span>Zelda</span>
                    <div v-for="(meal, index) in reimbursable.me.meal" :key="index" class="meal-entry">
                        <input type="text"
                               :value="getMealAmountFieldValue('reimbursable.me.meal', index)"
                               @input="updateMealAmountFromInput({ path: 'reimbursable.me.meal', index: index, value: $event.target.value })"
                               @focus="openCalculatorForMeal('reimbursable.me.meal', index)"
                               placeholder="0" readonly>
                        <input type="text"
                               v-model="meal.note"
                               placeholder="備註">
                        <button @click="removeMealEntry('reimbursable.me.meal', index)" class="remove-meal-btn"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <button @click="addMealEntry('reimbursable.me.meal')" class="add-meal-btn"><i class="fa-solid fa-plus"></i> 新增餐費</button>
                </div>
                <div class="input-wrapper meal-entries">
                    <span>Emma</span>
                    <div v-for="(meal, index) in reimbursable.wife.meal" :key="index" class="meal-entry">
                        <input type="text"
                               :value="getMealAmountFieldValue('reimbursable.wife.meal', index)"
                               @input="updateMealAmountFromInput({ path: 'reimbursable.wife.meal', index: index, value: $event.target.value })"
                               @focus="openCalculatorForMeal('reimbursable.wife.meal', index)"
                               placeholder="0" readonly>
                        <input type="text"
                               v-model="meal.note"
                               placeholder="備註">
                        <button @click="removeMealEntry('reimbursable.wife.meal', index)" class="remove-meal-btn"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <button @click="addMealEntry('reimbursable.wife.meal')" class="add-meal-btn"><i class="fa-solid fa-plus"></i> 新增餐費</button>
                </div>
                <div class="input-wrapper meal-entries">
                    <span>Andrew</span>
                    <div v-for="(meal, index) in reimbursable.brother.meal" :key="index" class="meal-entry">
                        <input type="text"
                               :value="getMealAmountFieldValue('reimbursable.brother.meal', index)"
                               @input="updateMealAmountFromInput({ path: 'reimbursable.brother.meal', index: index, value: $event.target.value })"
                               @focus="openCalculatorForMeal('reimbursable.brother.meal', index)"
                               placeholder="0" readonly>
                        <input type="text"
                               v-model="meal.note"
                               placeholder="備註">
                        <button @click="removeMealEntry('reimbursable.brother.meal', index)" class="remove-meal-btn"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <button @click="addMealEntry('reimbursable.brother.meal')" class="add-meal-btn"><i class="fa-solid fa-plus"></i> 新增餐費</button>
                </div>
            </div>
            <div class="input-group">
                <label>代墊車費</label>
                <div class="input-row">
                    <div class="input-wrapper">
                        <span>Zelda</span>
                        <input type="text" :value="getFieldValue('reimbursable.me.transport')" @input="updateValueFromInput({ path: 'reimbursable.me.transport', value: $event.target.value })" placeholder="0" @focus="openCalculator('reimbursable.me.transport')" readonly>
                    </div>
                    <div class="input-wrapper">
                        <span>Emma</span>
                        <input type="text" :value="getFieldValue('reimbursable.wife.transport')" @input="updateValueFromInput({ path: 'reimbursable.wife.transport', value: $event.target.value })" placeholder="0" @focus="openCalculator('reimbursable.wife.transport')" readonly>
                    </div>
                    <div class="input-wrapper">
                        <span>Andrew</span>
                        <input type="text" :value="getFieldValue('reimbursable.brother.transport')" @input="updateValueFromInput({ path: 'reimbursable.brother.transport', value: $event.target.value })" placeholder="0" @focus="openCalculator('reimbursable.brother.transport')" readonly>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>自家花費</h2>
            <div class="input-group">
                <label>自家餐費</label>
                <!-- 移除 input-row 容器，讓餐費區塊垂直堆疊 -->
                <div class="input-wrapper meal-entries">
                    <span>Zelda</span>
                    <div v-for="(meal, index) in our_own.me.meal" :key="index" class="meal-entry">
                        <input type="text"
                               :value="getMealAmountFieldValue('our_own.me.meal', index)"
                               @input="updateMealAmountFromInput({ path: 'our_own.me.meal', index: index, value: $event.target.value })"
                               @focus="openCalculatorForMeal('our_own.me.meal', index)"
                               placeholder="0" readonly>
                        <input type="text"
                               v-model="meal.note"
                               placeholder="備註">
                        <button @click="removeMealEntry('our_own.me.meal', index)" class="remove-meal-btn"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <button @click="addMealEntry('our_own.me.meal')" class="add-meal-btn"><i class="fa-solid fa-plus"></i> 新增餐費</button>
                </div>
                <div class="input-wrapper meal-entries">
                    <span>Emma</span>
                    <div v-for="(meal, index) in our_own.wife.meal" :key="index" class="meal-entry">
                        <input type="text"
                               :value="getMealAmountFieldValue('our_own.wife.meal', index)"
                               @input="updateMealAmountFromInput({ path: 'our_own.wife.meal', index: index, value: $event.target.value })"
                               @focus="openCalculatorForMeal('our_own.wife.meal', index)"
                               placeholder="0" readonly>
                        <input type="text"
                               v-model="meal.note"
                               placeholder="備註">
                        <button @click="removeMealEntry('our_own.wife.meal', index)" class="remove-meal-btn"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <button @click="addMealEntry('our_own.wife.meal')" class="add-meal-btn"><i class="fa-solid fa-plus"></i> 新增餐費</button>
                </div>
            </div>
            <div class="input-group">
                <label>自家車費</label>
                <div class="input-row">
                    <div class="input-wrapper">
                        <span>Zelda</span>
                        <input type="text" :value="getFieldValue('our_own.me.transport')" @input="updateValueFromInput({ path: 'our_own.me.transport', value: $event.target.value })" placeholder="0" @focus="openCalculator('our_own.me.transport')" readonly>
                    </div>
                    <div class="input-wrapper">
                        <span>Emma</span>
                        <input type="text" :value="getFieldValue('our_own.wife.transport')" @input="updateValueFromInput({ path: 'our_own.wife.transport', value: $event.target.value })" placeholder="0" @focus="openCalculator('our_own.wife.transport')" readonly>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>其他花費</h2>
            <div class="input-group">
                <label>Andrew 3D列印</label>
                <input type="text" :value="getFieldValue('reimbursable.brother.printer_3d')" @input="updateValueFromInput({ path: 'reimbursable.brother.printer_3d', value: $event.target.value })" placeholder="0" @focus="openCalculator('reimbursable.brother.printer_3d')" readonly>
            </div>
        </div>

        <div class="card results-card">
            <h2>計算結果</h2>
            <div class="result-item">
                <span class="label">{{ familyShouldReceiveText }}</span>
                <span class="value" :class="{'positive': familyShouldReceive > 0, 'negative': familyShouldReceive < 0, 'neutral': familyShouldReceive === 0}">{{ formatCurrency(Math.abs(familyShouldReceive)) }}</span>
            </div>
            <div class="result-item">
                <span class="label">{{ amountToGiveWifeText }}</span>
                <span class="value" :class="{'negative': amountToGiveWife > 0, 'positive': amountToGiveWife < 0, 'neutral': amountToGiveWife === 0}">
                    {{ formatCurrency(Math.abs(amountToGiveWife)) }}
                </span>
            </div>
        </div>

        <div class="card detail-card" v-if="allMealDetails.length > 0">
            <h2>餐費明細</h2>
            <ul>
                <li v-for="(detail, index) in allMealDetails" :key="index">
                    {{ detail.category }} - {{ detail.member }}: {{ formatCurrency(detail.amount) }}{{ detail.note ? ' (' + detail.note + ')' : '' }}
                </li>
            </ul>
        </div>

        <p class="footer-note">註：金額為綠色代表你應收的錢，紅色代表你應付的錢。</p>

        <!-- 計算機模組 -->
        <calculator-modal 
            :visible="calculatorState.visible"
            :initial-value="calculatorState.initialValue"
            :target-path="calculatorState.targetPath"
            :use-thousand-separator="true"
            @update:visible="calculatorState.visible = $event"
            @update:value="updateValueFromCalculator"
        ></calculator-modal>

        <!-- 自定義模態框 -->
        <div v-if="customModal.visible" class="custom-modal-overlay" @click.self="cancelCustomModal">
            <div class="custom-modal-content">
                <h3>{{ customModal.title }}</h3>
                <p>{{ customModal.message }}</p>
                <div v-if="customModal.type === 'confirm'" class="custom-modal-actions">
                    <button @click="confirmAction('load')" class="load-btn"><i class="fa-solid fa-download"></i><span>載入</span></button>
                    <button @click="confirmAction('delete')" class="cancel-btn"><i class="fa-solid fa-trash-can"></i><span>刪除</span></button>
                    <button @click="confirmAction('changeDate')" class="change-date-btn"><i class="fa-solid fa-calendar-days"></i><span>修改日期</span></button>
                </div>
            </div>
        </div>

        <!-- 短暫提示訊息模態框 -->
        <div v-if="tempMessageModal.visible" class="custom-modal-overlay temp-message-modal">
            <div :class="['custom-modal-content', tempMessageModal.type]">
                <p>{{ tempMessageModal.message }}</p>
            </div>
        </div>

        <!-- 變更日期模態框 -->
        <div v-if="dateChangeModal.visible" class="custom-modal-overlay" @click.self="cancelDateChange">
            <div class="date-change-modal-content">
                <h3>修改數據日期</h3>
                <p>將 <span style="font-weight: bold;">{{ dateChangeModal.originalDate }}</span> 的數據修改為：</p>
                <input type="date" v-model="dateChangeModal.newDate" ref="dateInput" @click="openDatePicker">
                <div class="custom-modal-actions">
                    <button @click="confirmDateChange"><i class="fa-solid fa-check"></i><span>確認修改</span></button>
                    <button @click="cancelDateChange" class="cancel-btn"><i class="fa-solid fa-xmark"></i><span>取消</span></button>
                </div>
            </div>
        </div>

        <!-- 覆蓋確認模態框 -->
        <div v-if="overwriteConfirmModal.visible" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <h3>覆蓋確認</h3>
                <p>{{ overwriteConfirmModal.message }}</p>
                <div class="custom-modal-actions">
                    <button @click="handleOverwriteChoice(true)"><i class="fa-solid fa-check"></i><span>確認覆蓋</span></button>
                    <button @click="handleOverwriteChoice(false)" class="cancel-btn"><i class="fa-solid fa-xmark"></i><span>取消</span></button>
                </div>
            </div>
        </div>

    </div>

    <script type="module" src="./js/script.js"></script>

</body>

</html>