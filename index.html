<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>桌遊社花費分攤計算機</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="./css/style.css"> <!-- 引入獨立的 style.css -->
    <link rel="stylesheet" href="./css/calculator.css">
    <link rel="stylesheet" href="./css/modal_styles.css"> <!-- 引入新的模態框樣式 -->
    <link rel="stylesheet" href="./css/firebase_styles.css"> <!-- 引入 Firebase 樣式 -->
    <link rel="stylesheet" href="./css/fab.css"> <!-- 引入懸浮按鈕樣式 -->
</head>

<body>

    <div id="app" v-cloak>
        <nav class="navbar">
            <div class="navbar-brand"></div>
            <div class="navbar-buttons" :class="{'logged-out-buttons': !user, 'logged-in-buttons': user}">
                <button v-if="!user" @click="showLoginModal" class="firebase-button login-button"><i class="fa-solid fa-right-to-bracket"></i><span>登入</span></button>
                <button v-if="user" @click="firebaseSignOut" class="firebase-button logout-button"><i class="fa-solid fa-right-from-bracket"></i><span>登出</span></button>
                <button v-if="user" @click="toggleAutoBackup" :class="{'firebase-button': true, 'auto-backup-on': enableAutoBackup, 'auto-backup-off': !enableAutoBackup}">
                    <i class="fa-solid fa-cloud-arrow-up"></i> <span>{{ enableAutoBackup ? 'Auto: on' : 'Auto: off' }}</span>
                </button>
                <button v-if="user" @click="backupToCloud(false)" class="firebase-button backup-button"><i class="fa-solid fa-cloud-arrow-up"></i> <span>備份</span></button>
                <button v-if="user" @click="restoreFromCloud" class="firebase-button restore-button"><i class="fa-solid fa-cloud-arrow-down"></i> <span>還原</span></button>
            </div>
        </nav>

        <!-- 登入模態框 -->
        <div v-if="loginModalVisible" class="custom-modal-overlay" @click.self="cancelLoginModal">
            <div class="custom-modal-content login-modal-content">
                <h3>登入 / 註冊</h3>
                <input type="email" v-model="loginEmail" placeholder="電子郵件" class="login-input" @keyup.enter="handleEmailSignIn">
                <input type="password" v-model="loginPassword" placeholder="密碼" class="login-input" @keyup.enter="handleEmailSignIn">
                <div class="remember-me-group">
                    <input type="checkbox" id="rememberMe" v-model="rememberMe">
                    <label for="rememberMe">記住我</label>
                </div>
                <div class="login-actions">
                    <button @click="handleEmailSignIn" class="firebase-button">登入</button>
                    <button @click="handleEmailSignUp" class="firebase-button signup-button">註冊</button>
                </div>
                <p v-if="loginError" class="login-error-message">{{ loginError }}</p>
            </div>
        </div>

        <h1>桌遊社花費分攤計算機</h1>
        <div class="top-controls">
            <div class="save-load-controls">
                <div class="save-clear-group">
                    <button @click="saveCurrentData" class="save-button"><i class="fa-solid fa-save"></i> 保存</button>
                    <button @click="clearInputs" class="clear-button"><i class="fa-solid fa-eraser"></i> 清空</button>
                </div>
                <select v-model="selectedSaveEntry" @change="handleSaveEntrySelection" class="load-dropdown">
                    <option value="">選擇要載入的數據</option>
                    <option v-for="entry in savedEntriesDesc" :key="entry.date" :value="entry.date">
                        {{ entry.date }}
                    </option>
                </select>
            </div>
        </div>
        <div v-if="loadMessage" class="message-display">
            {{ loadMessage }}
        </div>

        <!-- 使用 expense-input-group 組件來簡化代碼 -->
        <expense-input-group
            title="Zelda"
            member-key="me"
            :reimbursable-meal="reimbursable.me.meal"
            :reimbursable-transport="reimbursable.me.transport"
            :own-meal="our_own.me.meal"
            :own-transport="our_own.me.transport"
            @open-calculator="openCalculator"
            @open-calculator-for-meal="openCalculatorForMeal"
            @add-meal-entry="addMealEntry"
            @remove-meal-entry="removeMealEntry"
            @request-delete-confirmation="handleDeleteMealRequest"
            @request-transfer-meal="handleRequestTransferMeal"
            @update:reimbursable-meal="reimbursable.me.meal = $event"
            @update:reimbursable-transport="reimbursable.me.transport = $event"
            @update:own-meal="our_own.me.meal = $event"
            @update:own-transport="our_own.me.transport = $event"
        ></expense-input-group>

        <expense-input-group
            title="Emma"
            member-key="wife"
            :reimbursable-meal="reimbursable.wife.meal"
            :reimbursable-transport="reimbursable.wife.transport"
            :own-meal="our_own.wife.meal"
            :own-transport="our_own.wife.transport"
            @open-calculator="openCalculator"
            @open-calculator-for-meal="openCalculatorForMeal"
            @add-meal-entry="addMealEntry"
            @remove-meal-entry="removeMealEntry"
            @request-delete-confirmation="handleDeleteMealRequest"
            @request-transfer-meal="handleRequestTransferMeal"
            @update:reimbursable-meal="reimbursable.wife.meal = $event"
            @update:reimbursable-transport="reimbursable.wife.transport = $event"
            @update:own-meal="our_own.wife.meal = $event"
            @update:own-transport="our_own.wife.transport = $event"
        ></expense-input-group>

        <expense-input-group
            title="Andrew"
            member-key="brother"
            :reimbursable-meal="reimbursable.brother.meal"
            :reimbursable-transport="reimbursable.brother.transport"
            :brother-printer3d="reimbursable.brother.printer_3d"
            :is-brother="true"
            @open-calculator="openCalculator"
            @open-calculator-for-meal="openCalculatorForMeal"
            @add-meal-entry="addMealEntry"
            @remove-meal-entry="removeMealEntry"
            @request-delete-confirmation="handleDeleteMealRequest"
            @request-transfer-meal="handleRequestTransferMeal"
            @update:reimbursable-meal="reimbursable.brother.meal = $event"
            @update:reimbursable-transport="reimbursable.brother.transport = $event"
            @update:brother-printer3d="reimbursable.brother.printer_3d = $event"
        ></expense-input-group>

        <div class="card results-card">
            <h2>計算結果</h2>
            <div class="result-item">
                <span class="label">{{ familyShouldReceiveText }}</span>
                <span class="value" :class="{'positive': familyShouldReceive > 0, 'negative': familyShouldReceive < 0, 'neutral': familyShouldReceive === 0}">{{ formatCurrency(Math.abs(familyShouldReceive)) }}</span>
            </div>
            <div class="result-item">
                <span class="label">{{ amountToGiveWifeText }}</span>
                <span class="value" :class="{'negative': amountToGiveWife > 0, 'positive': amountToGiveWife < 0, 'neutral': amountToGiveWife === 0}">
                    {{ formatCurrency(Math.abs(amountToGiveWife)) }}
                </span>
            </div>
        </div>

        <div class="card detail-card" v-if="allMealDetails.length > 0">
            <h2>餐費明細</h2>
            <ul>
                <li v-for="(detail, index) in allMealDetails" :key="index">
                    {{ detail.category }} - {{ detail.member }}: {{ formatCurrency(detail.amount) }}{{ detail.note ? ' (' + detail.note + ')' : '' }}
                </li>
            </ul>
        </div>

        <p class="footer-note">註：金額為綠色代表Zelda應收的錢<br>紅色代表Zelda應付的錢</p>

        <!-- 計算機模組 -->
        <calculator-modal 
            :visible="calculatorState.visible"
            :initial-value="calculatorState.initialValue"
            :target-path="calculatorState.targetPath"
            :use-thousand-separator="true"
            @update:visible="calculatorState.visible = $event"
            @update:value="updateValueFromCalculator"
        ></calculator-modal>

        <!-- 自定義模態框 -->
        <div v-if="customModal.visible" class="custom-modal-overlay" @click.self="cancelCustomModal">
            <div class="custom-modal-content">
                <h3>{{ customModal.title }}</h3>
                <p>{{ customModal.message }}</p>
                <div v-if="customModal.type === 'confirm'" class="custom-modal-actions">
                    <button @click="confirmAction('load')" class="load-btn"><i class="fa-solid fa-download"></i><span>載入</span></button>
                    <button @click="confirmAction('delete')" class="cancel-btn"><i class="fa-solid fa-trash-can"></i><span>刪除</span></button>
                    <button @click="confirmAction('changeDate')" class="change-date-btn"><i class="fa-solid fa-calendar-days"></i><span>修改日期</span></button>
                </div>
            </div>
        </div>

        <!-- 短暫提示訊息模態框 -->
        <div v-if="tempMessageModal.visible" class="custom-modal-overlay temp-message-modal">
            <div :class="['custom-modal-content', tempMessageModal.type]">
                <p>{{ tempMessageModal.message }}</p>
            </div>
        </div>

        <!-- 變更日期模態框 -->
        <div v-if="dateChangeModal.visible" class="custom-modal-overlay" @click.self="cancelDateChange">
            <div class="date-change-modal-content">
                <h3>修改數據日期</h3>
                <p>將 <span style="font-weight: bold;">{{ dateChangeModal.originalDate }}</span> 的數據修改為：</p>
                <input type="date" v-model="dateChangeModal.newDate" ref="dateInput" @click="openDatePicker">
                <div class="custom-modal-actions">
                    <button @click="confirmDateChange"><i class="fa-solid fa-check"></i><span>確認修改</span></button>
                    <button @click="cancelDateChange" class="cancel-btn"><i class="fa-solid fa-xmark"></i><span>取消</span></button>
                </div>
            </div>
        </div>

        <!-- 通用確認模態框 -->
        <div v-if="confirmationModal.visible" class="custom-modal-overlay" @click.self="cancelConfirmation">
            <div class="custom-modal-content">
                <h3>操作確認</h3>
                <p>{{ confirmationModal.message }}</p>
                <div class="custom-modal-actions">
                    <button @click="executeConfirmation"><i class="fa-solid fa-check"></i><span>確認</span></button>
                    <button @click="cancelConfirmation" class="cancel-btn"><i class="fa-solid fa-xmark"></i><span>取消</span></button>
                </div>
            </div>
        </div>

        <!-- 覆蓋確認模態框 -->
        <div v-if="overwriteConfirmModal.visible" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <h3>覆蓋確認</h3>
                <p>{{ overwriteConfirmModal.message }}</p>
                <div class="custom-modal-actions">
                    <button @click="handleOverwriteChoice(true)"><i class="fa-solid fa-check"></i><span>確認覆蓋</span></button>
                    <button @click="handleOverwriteChoice(false)" class="cancel-btn"><i class="fa-solid fa-xmark"></i><span>取消</span></button>
                </div>
            </div>
        </div>

        <!-- 餐費轉移模態框 -->
        <div v-if="transferMealModal.visible" class="custom-modal-overlay" @click.self="cancelMealTransfer">
            <div class="custom-modal-content">
                <h3>轉移餐費給</h3>
                <div class="custom-modal-actions vertical-actions">
                    <button v-for="target in transferTargets" :key="target.name" @click="executeMealTransfer(target)" class="transfer-btn">
                        {{ target.name }}
                    </button>
                </div>
                <div class="custom-modal-actions" style="margin-top: 10px;">
                    <button @click="cancelMealTransfer" class="cancel-btn"><i class="fa-solid fa-xmark"></i><span>取消</span></button>
                </div>
            </div>
        </div>

        <!-- 快速新增費用按鈕 -->
        <button @click="openQuickAddModal" class="fab">
            <i class="fa-solid fa-plus"></i>
        </button>

        <!-- 快速新增費用模態框 -->
        <div v-if="quickAddModal.visible" class="custom-modal-overlay" @click.self="closeQuickAddModal">
            <div class="custom-modal-content">
                <h3>快速新增費用</h3>
                <div class="quick-add-form">
                    <div class="form-group">
                        <label for="quick-add-person">成員</label>
                        <select id="quick-add-person" v-model="quickAddModal.person">
                            <option value="me">Zelda</option>
                            <option value="wife">Emma</option>
                            <option value="brother">Andrew</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quick-add-type">類型</label>
                        <select id="quick-add-type" v-model="quickAddModal.type">
                            <option v-for="(label, value) in availableExpenseTypes" :value="value">{{ label }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quick-add-amount">金額</label>
                        <input type="text" id="quick-add-amount" :value="formatCurrency(quickAddModal.amount)" @focus="openQuickAddCalculator" placeholder="輸入金額" readonly>
                    </div>
                    <div class="form-group" v-if="isMealExpense">
                        <label for="quick-add-note">備註</label>
                        <input type="text" id="quick-add-note" v-model="quickAddModal.note" placeholder="(選填)">
                    </div>
                </div>
                <div class="custom-modal-actions quick-add-actions">
                    <button @click="saveQuickExpense"><i class="fa-solid fa-save"></i><span>儲存</span></button>
                    <button @click="closeQuickAddModal" class="cancel-btn"><i class="fa-solid fa-xmark"></i><span>取消</span></button>
                </div>
            </div>
        </div>

    </div>

    <script type="module" src="./js/script.js"></script>

</body>

</html>